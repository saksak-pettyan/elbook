<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kaneko.elbook.mapper.RentalMapper">

	<resultMap id="UserRentalRowMap" type="com.kaneko.elbook.dto.UserRentalRow">
		<id property="rentalId" column="RENTAL_ID" />
		<result property="bookId" column="BOOK_ID" />
		<result property="title" column="TITLE" />
		<result property="author" column="AUTHOR" />
		<result property="rentalDate" column="RENTAL_DATE" />
		<result property="returnDate" column="RETURN_DATE" />
		<result property="rentalCount" column="RENTAL_COUNT" />
		<result property="status" column="STATUS" />
	</resultMap>

	<!-- 貸出登録 -->
	<insert id="insertRental" parameterType="com.kaneko.elbook.domain.Rental"
		useGeneratedKeys="true" keyProperty="rentalId">
		INSERT INTO T_RENTAL (
		USER_ID, BOOK_ID, RENTAL_DATE, RETURN_DATE, RENTAL_COUNT, STATUS
		) VALUES (
		#{userId}, #{bookId}, #{rentalDate}, #{returnDate}, #{rentalCount},
		#{status}
		)
	</insert>

	<!-- 自分の貸出中一覧（返却前のみ） -->
	<select id="selectMyRentalCurrent" resultMap="UserRentalRowMap">
		SELECT
		r.RENTAL_ID,
		r.BOOK_ID,
		b.TITLE,
		b.AUTHOR,
		r.RENTAL_DATE,
		r.RETURN_DATE,
		r.RENTAL_COUNT,
		r.STATUS
		FROM T_RENTAL r
		JOIN T_BOOK b ON b.BOOK_ID = r.BOOK_ID
		WHERE r.USER_ID = #{userId}
		AND r.STATUS = '貸出中'
		ORDER BY r.RENTAL_DATE DESC, r.RENTAL_ID DESC
	</select>

	<!-- 自分の貸出履歴（全件） -->
	<select id="selectMyRentalHistory" resultMap="UserRentalRowMap">
		SELECT
		r.RENTAL_ID,
		r.BOOK_ID,
		b.TITLE,
		b.AUTHOR,
		r.RENTAL_DATE,
		r.RETURN_DATE,
		r.RENTAL_COUNT,
		r.STATUS
		FROM T_RENTAL r
		JOIN T_BOOK b ON b.BOOK_ID = r.BOOK_ID
		WHERE r.USER_ID = #{userId}
		ORDER BY r.RENTAL_DATE DESC, r.RENTAL_ID DESC
	</select>

	<select id="selectBookIdByRentalIdAndUserId" resultType="java.lang.Long">
		SELECT BOOK_ID
		FROM T_RENTAL
		WHERE RENTAL_ID = #{rentalId}
		AND USER_ID = #{userId}
</select>

	<!-- 返却（自分の貸出だけ返却可能） -->
	<update id="markReturned">
		UPDATE T_RENTAL
		SET
		RETURN_DATE = CURRENT_DATE(),
		STATUS = '返却済'
		WHERE RENTAL_ID = #{rentalId}
		AND USER_ID = #{userId}
		AND STATUS = '貸出中'
	</update>

  <!-- ========================= -->
  <!-- 管理画面：貸出状況/履歴 一覧 -->
  <!-- ========================= -->

  <resultMap id="AdminRentalRowMap" type="com.kaneko.elbook.dto.AdminRentalRow">
    <result property="userName"       column="USER_NAME" />
    <result property="bookName"       column="TITLE" />
    <result property="rentalDate"     column="RENTAL_DATE" />
    <result property="returnDate"     column="RETURN_DATE" />
    <result property="rentalQuantity" column="RENTAL_COUNT" />
    <result property="status"         column="STATUS" />
  </resultMap>

  <!-- 管理：貸出状況一覧（貸出中のみ） -->
  <select id="selectAdminCurrentRentals" resultMap="AdminRentalRowMap">
    SELECT
      u.USER_NAME,
      b.TITLE,
      r.RENTAL_DATE,
      r.RETURN_DATE,
      r.RENTAL_COUNT,
      r.STATUS
    FROM T_RENTAL r
    JOIN T_USER u ON u.USER_ID = r.USER_ID
    JOIN T_BOOK b ON b.BOOK_ID = r.BOOK_ID
    WHERE r.STATUS = #{statusRented}
    <if test="form != null and form.searchUserName != null and form.searchUserName != ''">
      AND u.USER_NAME LIKE CONCAT('%', #{form.searchUserName}, '%')
    </if>
    <if test="form != null and form.searchBookName != null and form.searchBookName != ''">
      AND b.TITLE LIKE CONCAT('%', #{form.searchBookName}, '%')
    </if>
    ORDER BY r.RENTAL_DATE DESC, r.RENTAL_ID DESC
  </select>

  <!-- 管理：貸出履歴一覧（全件＋条件） -->
  <select id="selectAdminRentalHistory" resultMap="AdminRentalRowMap">
    SELECT
      u.USER_NAME,
      b.TITLE,
      r.RENTAL_DATE,
      r.RETURN_DATE,
      r.RENTAL_COUNT,
      r.STATUS
    FROM T_RENTAL r
    JOIN T_USER u ON u.USER_ID = r.USER_ID
    JOIN T_BOOK b ON b.BOOK_ID = r.BOOK_ID
    WHERE 1=1
    <if test="form != null and form.searchUserName != null and form.searchUserName != ''">
      AND u.USER_NAME LIKE CONCAT('%', #{form.searchUserName}, '%')
    </if>
    <if test="form != null and form.searchBookName != null and form.searchBookName != ''">
      AND b.TITLE LIKE CONCAT('%', #{form.searchBookName}, '%')
    </if>
    <if test="form != null and form.searchRentalDateFrom != null">
      AND r.RENTAL_DATE &gt;= #{form.searchRentalDateFrom}
    </if>
    <if test="form != null and form.searchRentaDateTo != null">
      AND r.RENTAL_DATE &lt;= #{form.searchRentaDateTo}
    </if>
    <if test="form != null and form.searchStatus != null and form.searchStatus != ''">
      AND r.STATUS = #{form.searchStatus}
    </if>
    ORDER BY r.RENTAL_DATE DESC, r.RENTAL_ID DESC
  </select>


</mapper>
